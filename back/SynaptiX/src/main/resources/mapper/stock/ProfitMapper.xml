<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.stock.ProfitMapper">
    <select id="selectProfitList" resultType="map">
        SELECT
            CONCAT('prod2025', p.pk) AS code,
            p.Name AS name,
            td.Sales AS salesQty,
            p.Price AS salesPrice,
            td.Earning AS salesAmount,
            m.Price AS costPrice,
            pu.Cost AS costAmount,
            (p.Price - m.Price) AS profitUnit,
            (td.Earning - pu.Cost) AS profitAmount,
            CASE WHEN td.Earning = 0 THEN 0
                 ELSE ROUND((td.Earning - pu.Cost) / td.Earning * 100, 2)
            END AS profitRate
        FROM transaction_details td
        JOIN purchase pu
            ON td.Date = pu.Date
        JOIN product p ON td.ProductId = p.pk
        JOIN material m ON pu.MaterialId = m.pk
        <where>
            <if test="itemCode != null and itemCode != ''">
                AND CONCAT('prod2025', p.pk) LIKE CONCAT('%', #{itemCode}, '%')
            </if>
            <if test="itemName != null and itemName != ''">
                AND p.Name LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <!-- 카테고리 조건 제거: product 테이블에 Category 컬럼이 없거나 값이 다를 경우 오류 방지 -->
            <!--
            <if test="category != null and category != ''">
                AND p.Category = #{category}
            </if>
            -->
        </where>
    </select>
</mapper>